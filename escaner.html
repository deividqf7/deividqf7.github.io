<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FACAS X - Escáner de Materiales</title>
<style>
body {
  margin: 0;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(-45deg, #001f3f, #003366, #000, #00f0ff);
  background-size: 400% 400%;
  animation: gradientBG 15s ease infinite;
  color: #fff;
  overflow-x: hidden;
  text-align: center;
}

@keyframes gradientBG {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

header {
  background: linear-gradient(90deg, #001f3f, #003366);
  padding: 15px;
  font-size: 22px;
  font-weight: bold;
  color: #00f0ff;
  text-align: center;
}

.sidebar {
  height: 100%;
  width: 280px;
  position: fixed;
  top: 0;
  left: -290px;
  background-color: #111;
  overflow-x: hidden;
  transition: left 0.5s ease;
  padding-top: 60px;
  z-index: 1000;
}
.sidebar.active { left: 0; }
.sidebar a {
  padding: 12px 24px;
  text-decoration: none;
  font-size: 16px;
  color: #f1f1f1;
  display: block;
  transition: 0.3s;
}
.sidebar a:hover { background-color: #004080; }

.hamburger {
  position: fixed;
  top: 15px;
  left: 15px;
  width: 35px;
  height: 28px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  cursor: pointer;
  z-index: 1100;
}
.bar {
  height: 4px;
  width: 100%;
  background-color: white;
  border-radius: 4px;
  transition: 0.4s;
}
.hamburger.active .bar:nth-child(1) {
  transform: rotate(45deg) translate(6px, 6px);
}
.hamburger.active .bar:nth-child(2) { opacity: 0; }
.hamburger.active .bar:nth-child(3) {
  transform: rotate(-45deg) translate(6px, -6px);
}

.container {
  max-width: 800px;
  margin: 100px auto;
  padding: 30px;
  background: #001f3f;
  border-radius: 12px;
  border: 2px solid #00f0ff;
  box-shadow: 0 0 25px #00f0ff;
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
}

h2 {
  color: #00f0ff;
  margin-bottom: 15px;
}

#button-group {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 20px;
}

#image-container {
  position: relative;
  display: flex;
  justify-content: center;
  align-items: center;
  width: 80%;
  max-width: 400px;
  height: 300px;
  margin: 0 auto 20px auto;
  border: 2px solid #00f0ff;
  border-radius: 12px;
  background-color: #003366;
  overflow: hidden;
}

#preview {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: none;
}

#cameraPlaceholder {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 80px;
  opacity: 0.6;
}

#scan-line {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 4px;
  background: #00f0ff;
  border-radius: 2px;
  animation: scanAnim 2s linear infinite;
  display: none;
  z-index: 2;
  box-shadow: 0 0 20px #00f0ff;
}

@keyframes scanAnim {
  0% { top: 0%; opacity: 1; }
  50% { top: 90%; opacity: 0.6; }
  100% { top: 0%; opacity: 1; }
}

#resultado {
  margin-top: 20px;
  padding: 15px;
  background: #001f3f;
  border-radius: 10px;
  border: 1px solid #00f0ff;
  display: none;
  text-align: left;
}

.custom-button, #photoButton, #resetButton {
  background: linear-gradient(90deg, #001f3f, #003366);
  color: #00f0ff;
  border: none;
  padding: 12px 0;
  width: 150px;
  margin: 5px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  box-shadow: 0 0 15px #00f0ff;
  transition: 0.3s;
  font-family: Arial, sans-serif;
  font-size: 16px;
}
.custom-button:hover, #photoButton:hover, #resetButton:hover {
  background: linear-gradient(90deg, #00f0ff, #00cfff);
  color: #001f3f;
  box-shadow: 0 0 25px #00f0ff;
}

footer {
  background-color: #001f3f;
  color: #00f0ff;
  text-align: center;
  padding: 12px;
  margin-top: 40px;
}
</style>
</head>
<body>
<div class="hamburger" id="hamburger">
  <div class="bar"></div>
  <div class="bar"></div>
  <div class="bar"></div>
</div>

<div id="mySidebar" class="sidebar">
  <a href="nosotros.html">Nosotros</a>
  <a href="escaner-materiales.html">Escáner de Materiales</a>
  <a href="proceso-plastico.html">Proceso del Plástico</a>
  <a href="metodos-reciclaje.html">Métodos de Reciclaje</a>
  <a href="tipos-plasticos.html">Tipos de Plásticos</a>
  <a href="caracteristicas-material.html">Características del Material</a>
  <a href="impacto-ambiental.html">Impacto Ambiental</a>
  <a href="formacion-educacion.html">Formación y Educación Ambiental</a>
  <a href="creaciones-reciclado.html">Creaciones con Plástico Reciclado</a>
  <a href="curiosidades.html">Curiosidades y Datos Útiles</a>
  <a href="noticias-ambientales.html">Noticias Ambientales</a>
  <a href="evaluacion.html">Evaluación y Retroalimentación</a>
  <a href="ayuda.html">Ayuda</a>
</div>

<header>FACAS X - Escáner de Materiales</header>

<div class="container" id="scanner">
  <h2>Escáner de Botellas</h2>
  <p>Sube o toma una foto del código de barras del producto para identificarlo y conocer cómo reciclarlo.</p>

  <div id="button-group">
    <label for="fileInput" class="custom-button">Subir Imagen</label>
    <input type="file" accept="image/*" id="fileInput" style="display:none">
    <button id="photoButton">Tomar Foto</button>
  </div>

  <div id="image-container">
    <img id="preview" alt="Vista previa">
    <img id="cameraPlaceholder" src="https://static.vecteezy.com/system/resources/previews/009/266/389/non_2x/camera-icon-design-free-png.png" alt="Camera placeholder">
    <div id="scan-line"></div>
  </div>

  <div id="resultado"></div>
  <button id="resetButton" style="display:none;">Intentar otro escaneo</button>
</div>

<footer>© 2025 FACAS X. Todos los derechos reservados.</footer>

<audio id="success-sound" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg" preload="auto"></audio>
<audio id="error-sound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" preload="auto"></audio>

<script src="https://unpkg.com/@zxing/library@latest"></script>
<script>
/* ============================
    Mejora de decodificación JS
    ============================ */

// Elementos DOM (sin tocar diseño)
const fileInput = document.getElementById('fileInput');
const preview = document.getElementById('preview');
const cameraPlaceholder = document.getElementById('cameraPlaceholder');
const scanLine = document.getElementById('scan-line');
const resultado = document.getElementById('resultado');
const photoButton = document.getElementById('photoButton');
const resetButton = document.getElementById('resetButton');
const successSound = document.getElementById('success-sound');
const errorSound = document.getElementById('error-sound');

// Productos (mantener igual, se añadieron los códigos solicitados)
const productos = {
"7709947664513":{nombre:"Volt Energizante 300 ml",tipo:"PET 1",reciclaje:"Lávalo, retira etiqueta y deposítala en contenedor de plásticos reciclables.",descripcion:"Bebida energética popular en envase PET transparente.",impacto:"Reciclar esta botella ahorra suficiente energía para encender un bombillo 6 horas.",calorias:"110 kcal",ingredientes:"Agua, azúcar, cafeína, saborizantes"},
            "7702001111008":{nombre:"Coca-Cola 400 ml",tipo:"PET 1",reciclaje:"Retira la tapa y etiqueta, enjuaga y deposítala en contenedor de reciclaje.",descripcion:"Refresco clásico de cola en envase PET.",impacto:"Cada botella reciclada evita emisión de CO₂ y residuos en océanos.",calorias:"140 kcal",ingredientes:"Agua carbonatada, azúcar, colorante, saborizantes"},
            "7702001011001":{nombre:"Postobón Manzana 500 ml",tipo:"PET 1",reciclaje:"Enjuaga y separa de materiales no reciclables.",descripcion:"Refresco de manzana en envase PET.",impacto:"Reciclar ayuda a reducir residuos y consumo de energía.",calorias:"120 kcal",ingredientes:"Agua, azúcar, saborizante de manzana"},
            "7702011011015":{nombre:"Agua Cristal 600 ml",tipo:"PET 1",reciclaje:"Lava la botella, retira etiqueta y aplástala para ahorrar espacio.",descripcion:"Agua mineral embotellada.",impacto:"Reciclar una botella ahorra energía para encender bombillo 6 horas.",calorias:"0 kcal",ingredientes:"Agua mineral"},
            "7709992001008":{nombre:"Pepsi 400 ml",tipo:"PET 1",reciclaje:"Lava la botella y deposítala junto con otros plásticos reciclables.",descripcion:"Refresco de cola en envase PET.",impacto:"Reciclar reduce residuos y CO₂.",calorias:"140 kcal",ingredientes:"Agua carbonatada, azúcar, colorante, saborizantes"},
            "7702090042139":{nombre:"UVA POSTOBON 250 ml",tipo:"PET 1",reciclaje:"Lava la botella, retira etiqueta y deposítala en contenedor de plásticos reciclables.",descripcion:"Refresco sabor uva en presentación 250 ml.",impacto:"Reciclar ayuda a disminuir la contaminación plástica en fuentes hídricas.",calorias:"95 kcal",ingredientes:"Agua carbonatada, azúcar, saborizante de uva"},
            "7707151701031":{nombre:"Colombiana Cero 350 ml",tipo:"PET 1",reciclaje:"Enjuaga y deposítala en el contenedor de plásticos reciclables.",descripcion:"Versión sin azúcar de la tradicional Colombiana en 350 ml.",impacto:"Reciclar permite aprovechar el PET para nuevos envases.",calorias:"0 kcal",ingredientes:"Agua carbonatada, edulcorantes, saborizantes"},
            "7702057075088":{nombre:"Alcohol MK 350 ml",tipo:"PET 1",reciclaje:"Enjuaga el envase y deposítalo en el contenedor de reciclaje de plásticos.",descripcion:"Alcohol antiséptico para desinfección y limpieza en presentación 350 ml.",impacto:"Reciclar reduce residuos y evita acumulación de plásticos en vertederos.",calorias:"No aplica",ingredientes:"Alcohol etílico al 70%, agua"},
            "7700304580774": { nombre: "Jugo de Naranja Tree Fruts 300 ml", tipo: "PET 1", reciclaje: "Lava la botella, retira etiqueta y deposítala en el contenedor de plásticos reciclables.", descripcion: "Jugo de naranja marca Tree Fruts en presentación 300 ml.", impacto: "Reciclar ayuda a reducir el desperdicio plástico y conservar los recursos naturales.", calorias: "68 kcal", ingredientes: "Agua, jugo concentrado de naranja, azúcar, vitamina C"},
            "7702004013668": { nombre: "Pony Malta 200 cm³", tipo: "PET 1", reciclaje: "Lava el envase, retira etiqueta y deposítalo en reciclaje de plásticos.", descripcion: "Bebida maltada en presentación 200 cm³.", impacto: "Reciclar permite reutilizar el plástico para nuevos productos y reduce la contaminación.", calorias: "90 kcal", ingredientes: "Agua, malta, azúcar, caramelo" },
            "7707244561689": { nombre: "Agua Cielo 650 ml", tipo: "PET 1", reciclaje: "Lava la botella, retira etiqueta y aplástala antes de reciclarla.", descripcion: "Agua purificada Cielo en presentación 650 ml.", impacto: "Reciclar ayuda a disminuir los residuos plásticos en el ambiente y a conservar los recursos hídricos.", calorias: "0 kcal", ingredientes: "Agua purificada" },
            "7707133083216":{nombre:"Hit Mora 500 ml",tipo:"PET 1",reciclaje:"Retira etiqueta, enjuaga y deposítalo en reciclaje de plásticos.",descripcion:"Jugo natural de mora en presentación 500 ml.",impacto:"Reciclar reduce el impacto ambiental y fomenta la economía circular.",calorias:"95 kcal",ingredientes:"Agua, concentrado de mora, azúcar, vitamina C"},
            
            // Producto Volt Energy Dark añadido
            "7708129732491":{nombre:"Volt Energy Dark 300 ml",tipo:"PET 1",reciclaje:"Lávalo, retira etiqueta y deposítala en contenedor de plásticos reciclables.",descripcion:"Bebida energética sabor oscuro en envase PET.",impacto:"Reciclar esta botella ahorra suficiente energía para encender un bombillo 6 horas.",calorias:"110 kcal",ingredientes:"Agua, azúcar, cafeína, saborizantes naturales y colorantes"},

            // Producto Gatorade Frutos Tropicales añadido
            "7702192422051":{nombre:"Gatorade Frutos Tropicales 500 ml",tipo:"PET 1",reciclaje:"Enjuaga y deposítala en el contenedor de plásticos reciclables.",descripcion:"Bebida rehidratante sabor frutas tropicales en envase PET.",impacto:"Reciclar la botella ayuda a disminuir los residuos plásticos y el consumo de recursos.",calorias:"130 kcal",ingredientes:"Agua, carbohidratos, electrolitos, saborizantes, colorantes"},
            
            // Producto Postobón Uva 1.5 L añadido
            "7702090029550":{nombre:"Postobón Uva 1.5 L",tipo:"PET 1",reciclaje:"Lava la botella, retira etiqueta y deposítala en contenedor de plásticos reciclables. Aplástala para ahorrar espacio.",descripcion:"Refresco sabor uva en envase PET de gran formato.",impacto:"Reciclar ayuda a disminuir la contaminación plástica en fuentes hídricas.",calorias:"350 kcal",ingredientes:"Agua carbonatada, azúcar, saborizante de uva, colorantes"},

            // Producto Pedialyte Max Fresa añadido
            "7501033961557":{nombre:"Pedialyte Max Fresa 500 ml",tipo:"PET 1",reciclaje:"Enjuaga bien el envase para eliminar residuos, retira la etiqueta y deposítalo en el contenedor de plásticos.",descripcion:"Solución rehidratante oral sabor fresa para prevenir la deshidratación.",impacto:"El reciclaje de envases médicos y de salud es clave para asegurar la correcta gestión de residuos.",calorias:"20 kcal",ingredientes:"Agua, glucosa, cloruro de sodio, citrato de potasio, saborizantes"},
            
            // Producto Colombiana 1.5 L añadido
            "7707151754952":{nombre:"Colombiana 1.5 L",tipo:"PET 1",reciclaje:"Enjuaga, retira la tapa y etiqueta, y aplástala para facilitar el transporte al centro de reciclaje.",descripcion:"Refresco con sabor a kola, la gaseosa nacional de gran formato.",impacto:"Reciclar botellas de este tamaño tiene un gran impacto al reducir la cantidad de plástico virgen necesario.",calorias:"290 kcal",ingredientes:"Agua carbonatada, azúcar, colorante natural (caramelo), saborizantes"},

            // Producto NASHI LIMA LIMON 1700 ML añadido
            "7709952012156":{nombre:"NASHI LIMA LIMON 1700 ML",tipo:"PET 1",reciclaje:"Lava la botella, retira la tapa y etiqueta, y aplástala para facilitar su reciclaje debido a su gran volumen.",descripcion:"Refresco de lima-limón en formato familiar de 1.7 Litros.",impacto:"Reciclar botellas de más de 1.5L maximiza el ahorro de plástico y energía, contribuyendo a la sostenibilidad.",calorias:"380 kcal",ingredientes:"Agua carbonatada, azúcar, concentrado de limón, saborizantes"},
            
            // Producto ACEITE DIANA 450 ML añadido (Requiere limpieza especial)
            "7702028000323":{nombre:"Aceite Diana 450 ml",tipo:"PET 1",reciclaje:"Vacía completamente el envase, enjuágalo para remover residuos de aceite, retira la tapa y deposítalo en el contenedor de plásticos. ¡El aceite residual es contaminante, NO lo tires al desagüe!",descripcion:"Aceite vegetal de cocina en presentación de 450 ml.",impacto:"Reciclar botellas de aceite evita que el plástico y los residuos grasos contaminen las plantas de tratamiento de agua.",calorias:"No aplica (Grasa pura)",ingredientes:"Aceite de palma, antioxidantes"},

            // Nuevo producto PONY MALTA 1.5 L
            "702004025807":{nombre:"Pony Malta 1.5 L",tipo:"PET 1",reciclaje:"Lava la botella, retira la tapa y etiqueta, y aplástala para facilitar su reciclaje debido a su gran volumen. Deposítala en el contenedor de plásticos.",descripcion:"Bebida maltada en formato familiar de 1.5 Litros.",impacto:"Reciclar botellas grandes como esta ahorra más plástico y energía en el proceso de fabricación de nuevos envases.",calorias:"380 kcal",ingredientes:"Agua, malta, azúcar, caramelo, vitaminas"}
       };


// Reusar una instancia ZXing para evitar instancias repetidas
let zxingReader = null;
function getZXReader(){
  if(!zxingReader){
    zxingReader = new ZXing.BrowserMultiFormatReader();
  }
  return zxingReader;
}

/* Normaliza código leído para comparar mejor:
    - elimina no dígitos
    - quita ceros a la izquierda para comparar con versiones sin ceros
*/
function normalizeCode(code){
  if(!code) return '';
  const digits = code.replace(/\D/g,''); // solo dígitos
  // también devolver versión sin ceros a la izquierda
  const noLeading = digits.replace(/^0+/, '') || digits;
  return { raw: digits, noLeading };
}

/* Intenta decodificar el canvas en diferentes escalas
    para aumentar la probabilidad de lectura. */
async function tryDecodeWithScales(img){
  const reader = getZXReader();

  // resoluciones relativas para reescalar
  const scales = [1.0, 1.5, 0.8, 2.0]; // intentos con diferentes tamaños
  for(let s of scales){
    try{
      const canvas = document.createElement('canvas');
      const w = Math.max(200, Math.round(img.width * s));
      const h = Math.max(200, Math.round(img.height * s));
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext('2d');
      // draw scaled and sharpen a little by drawing twice (simple)
      ctx.drawImage(img, 0, 0, w, h);
      // try decodeFromCanvas (ZXing supports it)
      // some ZXing builds expose decodeFromCanvas; using decodeFromCanvas if present
      if(typeof reader.decodeFromCanvas === 'function'){
        try{
          const result = await reader.decodeFromCanvas(canvas);
          if(result && result.text) return result.text;
        }catch(e){
          // fallthrough to next attempt
          //console.debug('decodeFromCanvas failed at scale', s, e);
        }
      }
      // fallback: use decodeFromImageUrl with dataURL
      try{
        const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
        const result2 = await reader.decodeFromImageUrl(dataUrl);
        if(result2 && result2.text) return result2.text;
      }catch(e){
        //console.debug('decodeFromImageUrl failed at scale', s, e);
      }
    }catch(innerErr){
      // ignore and continue
      //console.warn('scale attempt error', innerErr);
    }
  }
  // if none worked, throw
  throw new Error('No se pudo decodificar en ninguna escala');
}

/* Función principal: procesa la imagen (File o Blob) */
async function escanearImagen(file){
  const reader = new FileReader();
  reader.onload = async function(ev){
    try{
      // mostrar preview y estado
      preview.src = ev.target.result;
      preview.style.display = 'block';
      cameraPlaceholder.style.display = 'none';
      resultado.style.display = 'block';
      resultado.innerHTML = 'Escaneando...';
      scanLine.style.display = 'block';
      resetButton.style.display = 'none';

      // crear imagen para decodificar
      const img = new Image();
      img.src = ev.target.result;
      await img.decode();

      // Intentar decodificar con varios tamaños / metodos
      let decodedText = null;
      try{
        decodedText = await tryDecodeWithScales(img);
      }catch(e){
        // fallback: intentar con reader.decodeFromImageUrl directo (otra vez)
        try{
          const readerInst = getZXReader();
          const dataUrl = ev.target.result;
          const r = await readerInst.decodeFromImageUrl(dataUrl);
          decodedText = r?.text || null;
        }catch(e2){
          decodedText = null;
        }
      }

      if(!decodedText){
        // No se pudo leer un código
        resultado.innerHTML = `<p>Producto no reconocido (no se detectó código de barras).\nIntenta con mejor iluminación o enfoque.</p>`;
        errorSound.play();
        return;
      }

      // Normaliza y compara
      const norm = normalizeCode(decodedText);
      const raw = norm.raw;
      const noLead = norm.noLeading;

      // Intentos de búsqueda en 'productos'
      let foundKey = null;

      // exact match raw
      if(raw && productos[raw]) foundKey = raw;
      // exact match noLeading
      if(!foundKey && noLead && productos[noLead]) foundKey = noLead;
      // try removing leading zeros from product keys (compare)
      if(!foundKey){
        for(const k of Object.keys(productos)){
          if(k.replace(/^0+/,'') === noLead) { foundKey = k; break; }
          if(noLead.endsWith(k.replace(/^0+/,''))) { foundKey = k; break; }
          if(k.endsWith(noLead)) { foundKey = k; break; }
        }
      }

      // If still not found, show code read and suggest
      if(!foundKey){
        resultado.innerHTML = `<p>Código leído: <strong>${decodedText}</strong></p>
          <p>No hay coincidencia en la base de datos. Revisa el código o agrégalo.</p>`;
        errorSound.play();
      } else {
        // show product
        mostrarInfoProducto(foundKey);
        successSound.play();
      }
    } catch(err){
      console.error('Error en escanearImagen:', err);
      resultado.innerHTML = `<p>Error al procesar la imagen: ${err.message || err}</p>`;
      errorSound.play();
    } finally {
      scanLine.style.display = 'none';
      resetButton.style.display = 'inline-block';
    }
  };
  reader.readAsDataURL(file);
}

/* Mostrar info (sin cambiar diseño) */
function mostrarInfoProducto(codigo){
  if(productos[codigo]){
    const p = productos[codigo];
    resultado.innerHTML = `<h3>${p.nombre}</h3>
      <p><b>Tipo de plástico:</b> ${p.tipo}</p>
      <p><b>Cómo reciclar:</b> ${p.reciclaje}</p>
      <p><b>Descripción:</b> ${p.descripcion}</p>
      <p><b>Impacto ambiental:</b> ${p.impacto}</p>
      <p><b>Calorías:</b> ${p.calorias}</p>
      <p><b>Ingredientes:</b> ${p.ingredientes}</p>`;
  } else {
    resultado.innerHTML = `<p>Producto no encontrado (código: ${codigo}).</p>`;
  }
}

/* event listeners (manteniendo tu flujo) */
fileInput.addEventListener('change', e=>{
  if(e.target.files && e.target.files.length>0) escanearImagen(e.target.files[0]);
});

/* Mejor flujo para tomar foto desde cámara: abrir video en el recuadro y capturar.
    Esto no cambia diseño: el video se añade dinámicamente y luego se quita. */
photoButton.addEventListener('click', async ()=>{
  try{
    // crear elementos video + controles temporales (no cambia estilos base)
    const videoContainer = document.createElement('div');
    const video = document.createElement('video');
    video.style.width = '100%';
    video.style.height = '100%';
    video.playsInline = true;
    video.muted = true;
    videoContainer.style.width = '100%';
    videoContainer.style.height = '100%';
    videoContainer.style.position = 'absolute';
    videoContainer.style.top = 0;
    videoContainer.style.left = 0;
    videoContainer.appendChild(video);

    // insertar dentro del image-container (para no tocar CSS global)
    const imageContainer = document.getElementById('image-container');
    imageContainer.appendChild(videoContainer);

    // ocultar preview/placeholder y mostrar animación
    preview.style.display = 'none';
    cameraPlaceholder.style.display = 'none';
    scanLine.style.display = 'block';
    resultado.style.display = 'block';
    resultado.innerHTML = 'Cámara activa - apunta al código y pulsa Capturar';

    // pedir stream (varios intentos de constraints)
    let stream = null;
    const constraintsTry = [
      { video: { facingMode: { exact: "environment" }, width: { ideal: 1280 }, height: { ideal: 720 } } },
      { video: { facingMode: "environment", width: { ideal: 1280 }, height: { ideal: 720 } } },
      { video: true }
    ];
    for(const c of constraintsTry){
      try{
        stream = await navigator.mediaDevices.getUserMedia(c);
        if(stream) break;
      }catch(err){ /* intentar siguiente */ }
    }
    if(!stream){
      resultado.innerHTML = '<p>No se pudo acceder a la cámara. Verifica permisos.</p>';
      scanLine.style.display = 'none';
      resetButton.style.display = 'inline-block';
      videoContainer.remove();
      return;
    }

    video.srcObject = stream;
    await video.play();

    // crear botón Capturar
    const snapButton = document.createElement('button');
    snapButton.innerText = 'Capturar Foto';
    snapButton.className = 'custom-button';
    snapButton.style.position = 'absolute';
    snapButton.style.bottom = '12px';
    snapButton.style.left = '50%';
    snapButton.style.transform = 'translateX(-50%)';
    videoContainer.appendChild(snapButton);

    // cuando pulsas capturar, tomamos frame y lo procesamos
    snapButton.addEventListener('click', async function onSnap(){
      snapButton.disabled = true;
      try{
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth || 1280;
        canvas.height = video.videoHeight || 720;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        // detener stream
        stream.getTracks().forEach(t => t.stop());
        // quitar video
        videoContainer.remove();

        // convertir canvas a blob y llamar a escanearImagen
        canvas.toBlob(blob => {
          if(blob) escanearImagen(blob);
        }, 'image/jpeg', 0.95);
      }catch(err){
        console.error('Error al capturar:', err);
        resultado.innerHTML = '<p>Error al capturar la imagen.</p>';
        resetButton.style.display = 'inline-block';
        scanLine.style.display = 'none';
        // intentar cerrar stream
        try{ stream.getTracks().forEach(t=>t.stop()); }catch(e){}
        try{ videoContainer.remove(); }catch(e){}
      } finally {
        snapButton.removeEventListener('click', onSnap);
      }
    });
  }catch(err){
    console.error('Error init camera capture:', err);
    resultado.innerHTML = '<p>No se pudo iniciar la cámara.</p>';
    scanLine.style.display = 'none';
    resetButton.style.display = 'inline-block';
  }
});

/* reinicio limpio (manteniendo diseño) */
resetButton.addEventListener('click', ()=>{
  resultado.style.display = 'none';
  preview.style.display = 'none';
  preview.src = '';
  scanLine.style.display = 'none';
  cameraPlaceholder.style.display = 'block';
  resetButton.style.display = 'none';

  // reset ZXing reader (liberando camera reader internal)
  try{ if(zxingReader && typeof zxingReader.reset === 'function') zxingReader.reset(); }catch(e){}
});

/* accessibility: stop any camera tracks al cambiar de página */
window.addEventListener('pagehide', ()=>{
  try{ if(zxingReader && typeof zxingReader.reset === 'function') zxingReader.reset(); }catch(e){}
});

/* ============================
    Añadido: Funcionalidad Hamburguesa y Navegación
    ============================ */
document.addEventListener('DOMContentLoaded', () => {
    const hamburger = document.getElementById('hamburger');
    const sidebar = document.getElementById('mySidebar');
    // Ya no necesitamos sidebarLinks para navegación, solo para cerrar el menú

    // Función para alternar el menú
    const toggleMenu = () => {
        sidebar.classList.toggle('active');
        hamburger.classList.toggle('active');
    };

    // Event listener al hacer click en la hamburguesa
    hamburger.addEventListener('click', toggleMenu);

    // Funcionalidad para cerrar la barra lateral al hacer clic en un enlace (permite la navegación)
    sidebar.querySelectorAll('a').forEach(link => {
        link.addEventListener('click', () => {
            // Cierra la barra lateral con un pequeño retraso ANTES de que el navegador cambie de página.
            setTimeout(toggleMenu, 50); 
            // El navegador automáticamente sigue el 'href' del enlace después de que este script termina.
        });
    });
});
</script>
</body>
</html>
